# Minimal 3D Printer Firmware (G-code + LCD + Button Control)

本專案是一個陽春版 3D 印表機韌體，支援 G-code 解析、LCD 顯示、單鍵控制、PID 控溫、列印進度估算與 EEPROM 儲存。

## 目錄
- [支援功能](#支援功能)
- [G-code 指令說明](#g-code-指令說明)
- [實體按鈕操作說明](#實體按鈕操作說明)
- [LCD 顯示模式](#lcd-顯示模式)
- [系統參數](#系統參數)
- [編譯需求](#編譯需求)
- [檔案結構](#檔案結構)
- [STL 轉 G-code 標準操作流程（SOP）](#stl-轉-g-code-標準操作流程sop)
- [模擬模式](#模擬模式)
- [聯絡作者](#聯絡作者)

---

## 支援功能

- G-code 指令解析
- PID 控溫（M301 可調）
- LCD 兩模式顯示 + 動畫（含進度條）
- 單鍵控制（短按/長按/雙擊）、強制停止
- 列印進度推估（根據 E 軸）
- `M290` 指令設定進度總量
- `M0` 指令可隨時暫停並等待按鈕確認
- `G4` 指令可在列印流程中插入延遲
- EEPROM 參數儲存
- 馬達移動支援簡易加速/減速
- 非阻塞 M109 加熱穩定後自動恢復並播放提示音
- 按鈕與端點採用中斷偵測（使用 `EnableInterrupt` 函式庫）
- 自動忽略 G-code 行號與檢查碼（`N...*nn` 格式）

---

## G-code 指令說明

| 指令              | 功能描述                                        | 範例                             |
|-------------------|-------------------------------------------------|----------------------------------|
| `G90`             | 切換為絕對座標模式（預設）                     | `G90`                           |
| `G91`             | 切換為相對座標模式                             | `G91`                           |
| `M82`             | 設定擠出機為絕對模式                           | `M82`                       |
| `M83`             | 設定擠出機為相對模式                           | `M83`                       |
| `G92`             | 設定目前座標（支援 X/Y/Z/E），E 會同步進度起點 | `G92 X0 Y0 Z0 E0`               |
| `G0`              | 快速移動（不擠料）                              | `G0 X50 Y0 F3000`               |
| `G1`              | 移動軸位置（支援 X/Y/Z/E 及 F 速度）            | `G1 X10 Y10 Z5 E100 F1200`       |
| `G28`             | 回原點並重設座標，可加 `X/Y/Z` 指定軸          | `G28 X Y` |
| `M104 Snnn`       | 設定目標溫度（不等待）                          | `M104 S200`                     |
| `M109 Snnn`       | 設定溫度並等待加熱完成（達標會播音樂）          | `M109 S200`                     |
| `M105`            | 回報目前溫度                                   | `M105`                          |
| `M114`            | 回報目前座標                                   | `M114`                      |
| `M0`              | 暫停列印直到按下按鈕                           | `M0`                            |
| `G4`              | 延遲指定時間（`S` 秒或 `P` 毫秒）              | `G4 S2`                         |
| `M301 Pn In Dn`   | 設定 PID 控溫參數並儲存至 EEPROM                | `M301 P20.0 I1.5 D60.0`         |
| `M400`            | 播放設定的音樂提示列印完成                      | `M400`                          |
| `M92 Xn Yn Zn En` | 設定各軸每毫米步數（steps/mm）                  | `M92 X25 Y25 Z25 E25`           |
| `M290 En`         | 設定列印進度總量（E 軸長度）                    | `M290 E1200`                    |
| `M220 Snnn`       | 調整移動速度倍率                              | `M220 S150`                  |
| `M221 Snnn`       | 調整擠出倍率                                  | `M221 S95`                   |
| `M500`            | 將目前設定存入 EEPROM                           | `M500`                          |
| `M503`            | 列印目前 PID 與 steps/mm 等參數                 | `M503`                          |
| `M84`             | 釋放馬達（停用步進驅動）                        | `M84`                           |


---

## 實體按鈕操作說明

| 操作方式           | 功能描述                                 |
|--------------------|------------------------------------------|
| **短按一次**       | 切換 LCD 顯示模式（兩種畫面循環）       |
| **長按 3 秒**      | 進入暫停確認畫面                         |
| **再次長按 3 秒**  | 確認進入暫停頁面，關閉加熱器             |
| **連按 2 次**      | （未設置）                              |

---

## LCD 顯示模式

| 模式名稱       | 顯示內容                                    |
|----------------|---------------------------------------------|
| 進度+溫度顯示  | `[#####-----] 50%` / `T:200.0°C S:220`      |
| Serial Monitor | 顯示最近處理的 G-code 指令                 |

- 每次短按按鈕將在上述兩種模式間切換
- 右下角持續顯示動畫符號（| / - \）作為系統運作提示

---

## 系統參數

- 預設 `eTotal = -1`（未設定時不顯示進度，可用 `M290` 設定總量）
- E 軸最大推擠保護：20000 步
- 控溫使用 PID 控制（`Kp`, `Ki`, `Kd` 可調）
- 預設加速步數 `ACCEL_STEPS = 50`

---

## 編譯需求

- Arduino IDE
- 支援板子：UNO / Nano / Mega 等
- 使用以下函式庫：
  - `LiquidCrystal_I2C`
  - `Bounce2`
  - `EEPROM`
  - `EnableInterrupt`

---

## 檔案結構

| 檔案         | 說明                      |
|--------------|---------------------------|
| `main.ino`           | 主程式入口                    |
| `gcode.cpp/h`        | G-code 解析                  |
| `motion.cpp/h`       | 多軸移動控制                  |
| `temp_control.cpp/h` | 溫度感測與 PID 控制          |
| `pins.cpp/h`         | 腳位設定                      |
| `button.cpp/h`       | 單鍵輸入處理                  |
| `interrupts.cpp/h`   | 中斷初始化                    |
| `state.cpp/h`        | 系統狀態管理                  |
| `tunes.cpp/h`        | 音樂與蜂鳴器                  |

---

## STL 轉 G-code 標準操作流程（SOP）

### Step 1：安裝與啟動

1. 下載並安裝 [PrusaSlicer](https://www.prusa3d.com/page/prusaslicer_424/)
2. 啟動後選擇「自訂印表機」設定模式

### Step 2：設定你的機器

- **Printer Type**：選「自訂 FFF」
- **Print Bed Shape**：依實際範圍設定，如 `X=50 Y=50 Z=50`
- **Nozzle diameter**：預設 `0.4 mm`
- **Firmware Flavor**：`Marlin`

#### 建議加入 Start / End G-code：

```gcode
; --- Start G-code ---
G21              ; 設定單位為毫米
G90              ; 絕對座標模式
M82              ; 擠出機使用絕對模式
G28              ; 歸零所有軸
G92 E0           ; 重設 E 軸
M104 S200        ; 設定噴頭溫度（不等待）
M105             ; 回報目前溫度（可選）
M109 S200        ; 等待噴頭加熱完成
G1 Z2 F1000      ; 提高噴頭避免碰撞
G1 X0 Y0 F6000   ; 噴頭移至原點
G1 E10 F300      ; 擠出一段做預備擠出
G92 E0           ; 重設 E 軸
; --- 開始列印 ---

; --- End G-code ---
G91              ; 相對座標模式
G1 E-2 F300      ; 回抽些許耗材防止滲料
G1 Z10 F1000     ; 提高噴頭避免刮傷列印品
G90              ; 回到絕對座標
G1 X0 Y40 F3000  ; 移動噴頭到側邊方便取件
M104 S0          ; 關閉噴頭加熱
M400             ; 播放列印完成提示音
; --- 列印結束 ---

```

### Step 3：匯入 STL

1. 點擊 **Add** 匯入 `.stl` 模型
2. 依需要調整尺寸、位置與旋轉

### Step 4：切片設定

- 選擇列印品質（`Draft` 或 `Fine`）
- 選擇材質（如 PLA）
- 設定速度、支撐材與填充率

```
Layer height = 0.2mm
Infill = 15%
Print speed = 20mm/s
```

### Step 5：產出 G-code

1. 按 **Slice Now**
2. 確認預覽後點選 **Export G-code**
3. 開啟匯出的 `.gcode`，搜尋 `filament used`=xxx mm，將數字填入 `M290 Exxx`

### Step 6：上傳與執行

1. 將 `.gcode` 傳至 Arduino，或透過串列監控逐行發送
2. 推薦使用 [Pronterface](https://github.com/kliment/Printrun/releases) 傳送指令

```
[切片軟體]
   ↓ 輸出 .gcode
[上位機：Pronterface / 自製監控程式]
   ↓ 一行行透過 Serial 傳送
[Arduino 韌體]
   └── getGcodeInput()
         └── processGcode()
              ├── G1 → moveAxes()
              ├── M104 → 設定溫度
              └── 其他 G / M 指令...
```

---

## 模擬模式

若無需連接切片軟體，可開啟模擬模式執行內建範例。請依需求到 `main/config.h` 定義下列旗標：

```cpp
#define SIMULATE_GCODE_INPUT   // 自動執行預設 G-code（包含移動與擠出）
#define SIMULATE_HEATER        // 模擬加熱（跳過實體感測器與 MOSFET）
#define SIMULATE_EXTRUDER      // 模擬擠出器，不實際驅動 E 軸步進
```

- **僅開 SIMULATE_HEATER**：可正常使用切片軟體，但忽略溫度加熱等待（`M109` 仍會達標）。
- **兩者皆開啟**：系統會執行一組預設 G-code，並模擬整體列印流程。
- **加入 SIMULATE_EXTRUDER**：在模擬模式下跳過 E 軸實際步進，可避免擠出耗材。
- 預設指令包含基本加熱、移動與擠出，可用來測試馬達與流程是否正常。
- 注意：此模式不會實際加熱，請避免裝入耗材避免空擠。

### 預設 G-code 範例（模擬模式內建指令）

```gcode
G90
G92 X0 Y0 Z0 E0
G1 X10 Y10 F1200
G1 Z2
M104 S200
M105
M400
```

### 音樂選擇

預設不會編譯任何完成提示音，如需音樂可在 `tunes.h` 定義下列其中一個旗標：

```cpp
#define USE_TUNE_MARIO
//#define USE_TUNE_CANON
//#define USE_TUNE_STAR_WARS
//#define USE_TUNE_TETRIS
```

同時定義兩個以上會在編譯時產生錯誤。

### 停用音效

若不需要蜂鳴器音樂功能，可在編譯時定義 `NO_TUNES` 旗標，
系統將排除音樂資料與 `playTune()` 的實作，相關呼叫也會被忽略。
在此模式下，可利用 `simpleBeep(pin, freq, duration_ms)` 播放短促蜂鳴聲作為提醒。

## Debug 日誌

若需要觀察溫度控制器的詳細輸出，可開啟 `temp_control.cpp` 內的
`#define DEBUG_LOGS`。取消註解後重新編譯即會在 Serial 監控視窗顯示
目前溫度、設定值與 PID 參數等資訊；再次註解即可停用紀錄。


---

## 聯絡作者

若有任何問題或建議，歡迎開 Issue 或 Pull Request！
